name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          echo "üîë Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "üì° Scanning SSH host keys for ${{ secrets.EC2_HOST }}..."
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          echo "‚úÖ SSH key setup completed"

      - name: Copy environment file to server
        run: |
          echo "üì§ Copying .env.production to server..."
          if [ ! -f .env.production ]; then
            echo "‚ùå Error: .env.production file not found"
            exit 1
          fi
          scp -v -i ~/.ssh/id_rsa .env.production ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/ || {
            echo "‚ùå Failed to copy .env.production file"
            exit 1
          }
          echo "‚úÖ Environment file copied successfully"

      - name: Create server env file and deploy
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            echo "================================================"
            echo "üöÄ Starting deployment process..."
            echo "================================================"

            # ÏÑúÎ≤Ñ ÌôòÍ≤Ω Î≥ÄÏàò ÏÉùÏÑ±
            echo "üìù Creating server environment file..."
            cat > /tmp/server.env << 'EOF'
          ${{ secrets.ENV_PRODUCTION }}
          EOF
            echo "‚úÖ Server environment file created"

            # ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏ Î∞è Ïù¥Îèô
            echo "üìÇ Checking project directory..."
            if [ ! -d "/var/www/cash-up" ]; then
              echo "‚ùå Error: Project directory /var/www/cash-up not found"
              exit 1
            fi
            cd /var/www/cash-up
            echo "‚úÖ Changed to project directory: $(pwd)"

            # Git ÏÉÅÌÉú ÌôïÏù∏
            echo "üìä Current git status:"
            git status

            # Git pull
            echo "üì• Pulling latest code from GitHub..."
            git pull origin main || {
              echo "‚ùå Git pull failed"
              exit 1
            }
            echo "‚úÖ Code updated successfully"

            # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
            echo "üîß Updating environment variables..."
            if [ ! -d "server" ]; then
              echo "‚ùå Error: server directory not found"
              exit 1
            fi
            mv /tmp/server.env server/.env || {
              echo "‚ùå Failed to move server.env"
              exit 1
            }
            echo "‚úÖ Server environment variables updated"

            # ÌîÑÎ°†Ìä∏ÏóîÎìú ÌôòÍ≤Ω Î≥ÄÏàò ÏÉùÏÑ±
            echo "üåê Creating frontend environment file..."
            echo "VITE_API_URL=/api" > .env.production
            echo "‚úÖ Frontend environment file created"

            # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï°¥Ïû¨ ÌôïÏù∏
            if [ ! -f "deploy.sh" ]; then
              echo "‚ùå Error: deploy.sh script not found"
              exit 1
            fi

            # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
            echo "üî® Running deployment script..."
            bash -x deploy.sh || {
              echo "‚ùå Deployment script failed with exit code $?"
              exit 1
            }

            echo "================================================"
            echo "‚úÖ Deployment process completed successfully!"
            echo "================================================"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "================================================"
          echo "üîç Verifying deployment..."
          echo "================================================"
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            # PM2 ÌîÑÎ°úÏÑ∏Ïä§ ÏÉÅÌÉú ÌôïÏù∏
            echo "üìã Checking PM2 process status..."
            pm2 status || {
              echo "‚ùå PM2 status check failed"
              echo "PM2 logs:"
              pm2 logs --lines 50 --nostream
              exit 1
            }

            # API Health Check
            echo "üè• Testing API health endpoint..."
            if ! curl -f http://localhost:8000/api/health; then
              echo "‚ùå API health check failed"
              echo "Server logs:"
              pm2 logs cash-up-server --lines 50 --nostream || true
              exit 1
            fi

            echo "================================================"
            echo "‚úÖ All services are running correctly!"
            echo "================================================"
          ENDSSH

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: Deployment Success Notification
        if: success()
        run: |
          echo "================================================"
          echo "‚úÖ Deployment completed successfully!"
          echo "================================================"
          echo "Server: ${{ secrets.EC2_HOST }}"
          echo "Time: $(date)"
          echo "================================================"

      - name: Deployment Failure Notification
        if: failure()
        run: |
          echo "================================================"
          echo "‚ùå DEPLOYMENT FAILED!"
          echo "================================================"
          echo ""
          echo "üîç Debugging Information:"
          echo "  - Time: $(date)"
          echo "  - Branch: ${{ github.ref_name }}"
          echo "  - Commit: ${{ github.sha }}"
          echo "  - Actor: ${{ github.actor }}"
          echo "  - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "üìã Failed Job Steps:"
          echo "  Check the logs above to identify which step failed:"
          echo "  1. Setup SSH Key"
          echo "  2. Copy environment file to server"
          echo "  3. Create server env file and deploy"
          echo "  4. Verify deployment"
          echo ""
          echo "üí° Common Issues:"
          echo "  - SSH connection problems ‚Üí Check EC2_HOST, EC2_USER, SSH_KEY secrets"
          echo "  - Missing .env.production ‚Üí Ensure file exists in repository"
          echo "  - Git pull failed ‚Üí Check for merge conflicts on server"
          echo "  - Deploy script failed ‚Üí Check deploy.sh for errors"
          echo "  - Health check failed ‚Üí Check PM2 logs and server status"
          echo ""
          echo "üîß Quick Debug Commands:"
          echo "  ssh <user>@<host> 'cd /var/www/cash-up && pm2 logs'"
          echo "  ssh <user>@<host> 'cd /var/www/cash-up && git status'"
          echo "  ssh <user>@<host> 'pm2 status'"
          echo ""
          echo "================================================"